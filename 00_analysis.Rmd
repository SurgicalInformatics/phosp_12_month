---
title: "PHOSP 12 month"
author: "PHOSP-COVID collaborative"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document:
    reference_docx: template.docx  
---

```{r setup, include=FALSE}
if (knitr::is_html_output()){
  knitr::opts_chunk$set(echo = TRUE,
                        warning = FALSE,
                        message = FALSE)
} else {
  knitr::opts_chunk$set(echo = FALSE,
                        warning = FALSE,
                        message = FALSE)
}

library(finalfit)
library(knitr)
library(tidyverse)
library(rmarkdown)

summary_factorlist <- purrr::partial(finalfit::summary_factorlist, na_to_prop = FALSE)

mykable = function(x){
  knitr::kable(x, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r", "r", "r"), 
               booktabs = TRUE, 
               linesep = "") 
}
```

```{r eval=FALSE, include=FALSE}
# FROM phosp_first project
# This is to get original 1077, study IDs are saved as keep
# Filter at 240 days follow up. 
load("full_image_250321.Rdata")

study_id_240 = phosp %>% 
  group_by(study_id) %>% 
  fill(crf1a_date_dis, crf3a_visit_date, .direction = "downup") %>% 
  select(study_id, crf1a_date_dis, crf3a_visit_date) %>% 
  distinct(study_id, .keep_all = TRUE) %>% 
  mutate(discharge2review = (crf3a_visit_date - crf1a_date_dis) %>% as.numeric()) %>% 
  filter(discharge2review <= 240 | is.na(discharge2review)) %>% 
  pull(study_id)

keep = phosp_hosp %>% 
  filter(tier == 2) %>% 
  filter(study_id %in% study_id_before_end_nov) %>%
  filter(study_id %in% study_id_240) %>% 
  drop_na(crf1a_resp_support_4levels) %>% 
  filter(!is.na(crf1a_sex)) %>% 
  filter(study_id != "28-31") %>% # Temp remove as no 3 m data coming through
  pull(study_id)

rm(list=setdiff(ls(), "keep")) 
```

```{r eval=FALSE, include=FALSE}
# For exploration 
library(readr) # loaded with tidyverse anyway
datadir = "/home/common/phosp/raw/"
timestamp = "2021-06-21_1001"
phosp   = read_rds(paste0(datadir, "phosp_", timestamp, ".rds"))
lastrun = Sys.time()
source("/home/eharrison/phosp_clean/02_functions.R")
```


```{r eval=FALSE, include=FALSE}
# Only those followed up within 240 days for new patients only--------------------------------------------------
study_id_240 = phosp %>% 
  filter(!study_id %in% keep) %>% 
  
  group_by(study_id) %>% 
  fill(crf1a_date_dis, crf3a_visit_date, .direction = "downup") %>% 
  select(study_id, crf1a_date_dis, crf3a_visit_date) %>% 
  distinct(study_id, .keep_all = TRUE) %>% 
  mutate(discharge2review = (crf3a_visit_date - crf1a_date_dis) %>% as.numeric()) %>% 
  filter(discharge2review <= 240 | is.na(discharge2review)) %>% 
  pull(study_id)

# Define tier 2 --------------------------------------------------------------------------
tier2_study_id = phosp %>% 
  filter(!is.na(crf3b_visit)) %>% 
  distinct(study_id) %>% 
  pull(study_id)

# Variable definitions-------------------------------------------------------------------
phosp = phosp %>% 
  filter(study_id %in% tier2_study_id) %>% 
  filter(study_id %in% c(keep, study_id_240)) %>% 
  mutate(
    cohort = ifelse(study_id %in% keep, "First cohort", "Second cohort")
  )
```


```{r eval=FALSE, include=FALSE}
source("/home/eharrison/phosp_clean/03_prep.R")
source("/home/eharrison/phosp_clean/05_kco.R")
save.image("full_image_210621.Rdata", compress = TRUE)
```

```{r}
load("full_image_210621.Rdata")
```

```{r}
# FROM phosp_first project
# Any joins can be temporarily done here, then moved to cleaning. 
phosp_hosp = phosp_hosp %>% 
  left_join(phosp %>% 
              filter(redcap_event_name == "3 Months (1st Research Visit)") %>% 
              select(study_id, crf3a_bmi, crf3a_bmi_2levels, crf3a_bmi_5levels) %>% 
              drop_na(crf3a_bmi)
  )

# Temp variable changes / collapses
## Pull psq_recovered from 6 week data if missing at 3 months
phosp_hosp = phosp_hosp %>% 
  left_join(phosp_3m %>% select(study_id, psq_recovered, eq5d5l_summary_delta, discharge_to_3m_review)) %>%
  left_join(phosp_6w %>% select(study_id, 
                                psq_recovered_6w = psq_recovered,
                                eq5d5l_summary_delta_6w = eq5d5l_summary_delta)) %>% 
  mutate(
    psq_recovered = case_when(
      is.na(psq_recovered) & !is.na(psq_recovered_6w) ~ psq_recovered_6w,
      TRUE ~ psq_recovered
    ) %>% fct_recode("No" = "Not sure") %>% 
      fct_relevel("No"),
    
    eq5d5l_summary_delta = case_when(
      is.na(eq5d5l_summary_delta) & !is.na(eq5d5l_summary_delta_6w) ~ eq5d5l_summary_delta_6w,
      TRUE ~ eq5d5l_summary_delta)
  ) %>% 
  ff_relabel_df(phosp_hosp)

# Smoking
phosp_smoking = phosp_3m %>% 
  select(study_id, patient_sq_n) %>% 
  left_join(phosp_6w %>% select(study_id, patient_sq_n_6w = patient_sq_n)) %>% 
  mutate(patient_sq_n= case_when(
    is.na(patient_sq_n) & !is.na(patient_sq_n_6w) ~ patient_sq_n_6w,
    TRUE ~ patient_sq_n
  ) %>% 
    ff_label("Smoking")
  ) %>% 
  select(study_id, patient_sq_n)

phosp_hosp = phosp_hosp %>% 
  left_join(phosp_smoking) %>% 
    mutate(patient_sq_n = ff_label(patient_sq_n, "Smoking"))
```

```{r}
# Make 12 month object. 
## Note crf3b_visit must be 12 months
phosp_12m = phosp %>% 
  filter(is.na(redcap_repeat_instance)) %>% 
  filter(redcap_event_name == "12 Months (2nd Research Visit)") %>% 
  mutate(discharge_to_12m_review = (crf3a_visit_date - crf1a_date_dis) %>% as.numeric() %>% 
           ff_label("Discharge to 12m review (days)")) %>%  
  
  # filter(crf3b_visit == "12 months visit") %>% # 395 with this in; 545 with it out. 
  purrr::discard(~all(is.na(.)))
```

```{r}
# Put together linked set
phosp_3m = phosp_3m %>% 
  left_join(phosp_hosp %>% select(study_id, crf1a_resp_support_4levels))
```

## Data

Data from: `r timestamp`.

Total patients: `r dim(phosp_hosp)[1]`.

### Patients with 12 month data. 

```{r}
phosp_12m %>% 
  select(c("crf3b_visit", "psq_recovered", "eq5d5l_summary")) %>% 
  missing_glimpse() %>% 
  knitr::kable(align = c("l", "l", "r", "r", "r", "r", "r", "r", "r", "r", "r"), 
                 booktabs = TRUE, 
                 linesep = "") 
```

```{r eval=FALSE, include=FALSE}
## Include 6 weeks if missing at 3 months or not? 
phosp_3m  = phosp_3m %>% 
  left_join(phosp_6w %>% select(study_id, 
                                psq_recovered_6w = psq_recovered,
                                eq5d5l_summary_6w = eq5d5l_summary,
                                eq5d5l_summary_delta_6w = eq5d5l_summary_delta)) %>% 
  mutate(
    psq_recovered = case_when(
      is.na(psq_recovered) & !is.na(psq_recovered_6w) ~ psq_recovered_6w,
      TRUE ~ psq_recovered
    ), # %>% fct_recode("No" = "Not sure") %>% 
       # fct_relevel("No"),
    
    eq5d5l_summary = case_when(
      is.na(eq5d5l_summary) & !is.na(eq5d5l_summary_6w) ~ eq5d5l_summary_6w,
      TRUE ~ eq5d5l_summary),
    
    eq5d5l_summary_delta = case_when(
      is.na(eq5d5l_summary_delta) & !is.na(eq5d5l_summary_delta_6w) ~ eq5d5l_summary_delta_6w,
      TRUE ~ eq5d5l_summary_delta)
  ) %>% 
  ff_relabel_df(phosp_hosp)
```

### Patients with 12 month data matched to 3 month. 

```{r}
phosp_3m_12m = phosp_3m %>% 
  select(study_id, crf1a_resp_support_4levels, psq_recovered, eq5d5l_summary) %>% 
  left_join(
    phosp_12m %>% 
      select(study_id, psq_recovered, eq5d5l_summary), 
    by = "study_id", suffix = c("_3m", "_12m") 
  )
```

```{r}
phosp_3m_12m = phosp_3m_12m %>% 
  mutate(eq5d5l_summary_3m_12m_delta = eq5d5l_summary_12m - eq5d5l_summary_3m,
         psq_recovered_3m_matched = if_else(!is.na(psq_recovered_3m) & !is.na(psq_recovered_12m), "Matched", NA_character_)
  )

phosp_3m_12m %>% 
  select(c("eq5d5l_summary_3m_12m_delta", "psq_recovered_3m_matched")) %>% 
  missing_glimpse() %>% 
  mykable()
```

## First vs second cohort comparison

```{r}
explanatory = c("swab_pcr_result", 
                "discharge_to_3m_review",
                "crf1a_resp_support_4levels",
                
                "age_admission", 
                "crf1a_sex", 
                "crf1b_eth_5levels", 
                "imd_quintile",
                "crf3a_bmi",
                "crf3a_bmi_2levels",
                "crf3a_bmi_5levels", 
                
                "patient_sq_n",
                
                # Comorbidities
                "no_comorbid",
                "no_comorbid_3levels",
                "crf1a_com_card", "crf1a_com_neupsy",
                "crf1a_com_res", "crf1a_com_rheu",
                "crf1a_com_gast", "crf1a_com_mer", 
                "crf1a_com_mh", "crf1a_com_diab",
                "crf1a_com_id",
                
                "crf1a_admission_duration",
                
                "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")

dependent = "cohort"
phosp_hosp %>% 
  summary_factorlist(dependent,  explanatory, 
                     na_include = TRUE, na_include_dependent = TRUE, 
                     add_col_totals = TRUE, cont_nonpara = c(2, 4:20), p = TRUE, 
                     total_col = TRUE) %>% 
  ff_remove_ref() %>% 
  ff_column_totals(phosp_hosp, dependent) %>% 
  ff_row_totals(phosp_hosp, dependent, explanatory, missing_column = FALSE) %>% 
  mykable()
```


## Better or worse at 12 months?

### Difference from zero

```{r}
phosp_3m_12m %>% 
  mutate(eq5d5l_summary_3m_12m_delta_change = case_when(
    eq5d5l_summary_3m_12m_delta == 0 ~ "No change (equals 0)",
    eq5d5l_summary_3m_12m_delta > 0 ~ "Improvement (>0)",
    eq5d5l_summary_3m_12m_delta < 0 ~ "Worse (<0)"
  )   %>%
    factor() %>%
    fct_relevel("No change (equals 0)")
  ) %>% 
  drop_na(eq5d5l_summary_3m_12m_delta_change) %>% 
  count(eq5d5l_summary_3m_12m_delta_change) %>% 
  mutate(nn = sum(n),
         prop = (100*n/nn) %>% round_tidy(1)) %>% 
  mykable()
 
```

### Difference from -5 to +5

```{r}
phosp_3m_12m %>% 
  mutate(eq5d5l_summary_3m_12m_delta_change = case_when(
    eq5d5l_summary_3m_12m_delta > 5 ~ "Improvement (>5)",
    eq5d5l_summary_3m_12m_delta < -5 ~ "Worse (<-5)",
    eq5d5l_summary_3m_12m_delta <=5 & 
      eq5d5l_summary_3m_12m_delta >= -5~ "No change (-5 to +5)",
  )   %>%
    factor() %>%
    fct_relevel("No change (-5 to +5)")
  ) %>% 
  drop_na(eq5d5l_summary_3m_12m_delta_change) %>% 
  count(eq5d5l_summary_3m_12m_delta_change) %>% 
  mutate(nn = sum(n),
         prop = (100*n/nn) %>% round_tidy(1)) %>% 
  mykable()
 
```


### Figure: EQ5D VAS

```{r}
phosp_3m_12m %>% 
  drop_na(eq5d5l_summary_3m, eq5d5l_summary_12m) %T>% 
  {total_n <<- dim(.)[1]} %>% 
  ggplot_lancet(aes(x = eq5d5l_summary_3m, y = eq5d5l_summary_12m)) + 
  geom_abline(aes(slope = 1, intercept = 0)) +
  geom_point() +
  ggtitle("EQ5D VAS 3m vs 12m",
          paste("Above line: patient has improved. Total N =", total_n, "."))
```

### Figure: EQ5D VAS stratified by level of support

```{r}
phosp_3m_12m %>% 
  drop_na(eq5d5l_summary_3m, eq5d5l_summary_12m, crf1a_resp_support_4levels) %T>% 
  {total_n <<- dim(.)[1]} %>% 
  ggplot_lancet(aes(x = eq5d5l_summary_3m, y = eq5d5l_summary_12m)) + 
  geom_abline(aes(slope = 1, intercept = 0)) +
  geom_point() +
  facet_wrap(. ~ crf1a_resp_support_4levels) +
  ggtitle("EQ5D VAS 3m vs 12m",
          paste("Above line: patient has improved. Total N =", total_n, "."))
```

Unexpected that there are so many reporting worse overall health. 


```{r}
dependent = "eq5d5l_summary_3m_12m_delta_change"
phosp_3m_12m %>% 
  mutate(eq5d5l_summary_3m_12m_delta_change = case_when(
    eq5d5l_summary_3m_12m_delta == 0 ~ "No change/worse",
    eq5d5l_summary_3m_12m_delta > 0 ~ "Improvement",
    eq5d5l_summary_3m_12m_delta < 0 ~ "No change/worse"
  )   %>%
    factor() %>%
    fct_relevel("No change")
  ) %>% 
  left_join(phosp_hosp %>% select(study_id, explanatory)) %T>%
  {data_in <<- .} %>% 
  summary_factorlist(dependent,  explanatory, 
                     na_include = TRUE, na_include_dependent = TRUE, 
                     add_col_totals = TRUE, cont_nonpara = c(2, 4:20), p = TRUE, 
                     total_col = TRUE) %>% 
  ff_remove_ref() %>% 
  ff_column_totals(data_in, dependent) %>% 
  ff_row_totals(data_in, dependent, explanatory, missing_column = FALSE) %>% 
  mykable()
```

```{r}
explanatory = c("swab_pcr_result", 
                "discharge_to_3m_review",
                "age_admission", 
                "crf1a_sex", 
                "crf1b_eth_5levels", 
                "imd_quintile",
                "crf3a_bmi",
                "crf3a_bmi_2levels",
                "crf3a_bmi_5levels", 
                
                "patient_sq_n",
                
                # Comorbidities
                "no_comorbid",
                "no_comorbid_3levels",
                "crf1a_com_card", "crf1a_com_neupsy",
                "crf1a_com_res", "crf1a_com_rheu",
                "crf1a_com_gast", "crf1a_com_mer", 
                "crf1a_com_mh", "crf1a_com_diab",
                "crf1a_com_id",
                
                "crf1a_admission_duration",
                
                "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")
```


```{r}
phosp_3m_12m %>% 
  count(psq_recovered_3m, psq_recovered_12m) %>% 
  spread(psq_recovered_12m, n)
```

```{r}
phosp_3m_12m %>% 
  drop_na(psq_recovered_3m, psq_recovered_12m) %>% 
  count(psq_recovered_3m, psq_recovered_12m) %>% 
  spread(psq_recovered_12m, n)
# 201 rows
# 209 rows if include 6 weeks
```

```{r}
phosp_3m_12m %>% 
  drop_na(eq5d5l_summary_3m, eq5d5l_summary_12m) %>% 
  mutate(eq5d5l_summary_3m_12m_delta = eq5d5l_summary_12m - eq5d5l_summary_3m) %>% 
  ggplot(aes(x = eq5d5l_summary_3m_12m_delta)) +
  geom_histogram() +
  facet_wrap(. ~ crf1a_resp_support_4levels)
# 258 not including 6 weeks
# 202 including 6 weeks!
```


```{r}
phosp_3m_12m %>% 
  drop_na(eq5d5l_summary_3m, eq5d5l_summary_12m) %>% 
  mutate(eq5d5l_summary_3m_12m_delta = eq5d5l_summary_12m - eq5d5l_summary_3m) %>% 
  mutate(eq5d5l_summary_3m_12m_delta_change = case_when(
    eq5d5l_summary_3m_12m_delta == 0 ~ "No change",
    eq5d5l_summary_3m_12m_delta > 0 ~ "Improvement",
    eq5d5l_summary_3m_12m_delta < 0 ~ "Worse"
  )   %>%
    factor() %>%
    fct_relevel("No change")
  ) %>% 
  count(eq5d5l_summary_3m_12m_delta_change)

```

### Check above is right by doing a different way (spread vs join)
Yes it is the same. 

```{r}
phosp %>% 
  filter(is.na(redcap_repeat_instance)) %>% 
  filter(redcap_event_name == "3 Months (1st Research Visit)" |
           redcap_event_name == "12 Months (2nd Research Visit)") %>% 
  select(study_id, redcap_event_name, eq5d5l_summary) %>% 
  spread(redcap_event_name, eq5d5l_summary) %>% 
  filter(!is.na(`3 Months (1st Research Visit)`) & !is.na(`12 Months (2nd Research Visit)`)) %>% 
  mutate(Delta = `12 Months (2nd Research Visit)` - `3 Months (1st Research Visit)`) %>% 
  arrange(Delta) %>% 
  left_join(phosp_3m %>% select(study_id, crf1a_resp_support_4levels)) 

```


```{r}
phosp %>% 
  filter(is.na(redcap_repeat_instance)) %>% 
  filter(redcap_event_name == "3 Months (1st Research Visit)" |
           redcap_event_name == "12 Months (2nd Research Visit)") %>% 
  select(study_id, redcap_event_name, eq5d5l_summary) %>% 
  spread(redcap_event_name, eq5d5l_summary) %>% 
  filter(!is.na(`3 Months (1st Research Visit)`) & !is.na(`12 Months (2nd Research Visit)`)) %>% 
  mutate(Delta = `12 Months (2nd Research Visit)` - `3 Months (1st Research Visit)`) %>% 
  arrange(Delta) %>% 
  left_join(phosp_3m %>% select(study_id, crf1a_resp_support_4levels)) %T>% 
  {total_n <<- dim(.)[1]} %>% 
  ggplot(aes(x = `3 Months (1st Research Visit)`, y = `12 Months (2nd Research Visit)`)) + 
  geom_abline(aes(slope = 1, intercept = 0)) +
  geom_point() +
  ggtitle("EQ5D summary 3m vs 12m",
          paste("Above line: patient has improved. N =", total_n, "."))

```


```{r}
phosp %>% 
  filter(is.na(redcap_repeat_instance)) %>% 
  filter(redcap_event_name %in% c("3 Months (1st Research Visit)", 
                                  "12 Months (2nd Research Visit)")) %>% 
  select(study_id, redcap_event_name, matches("eq5d5l_[q12345]*_numeric")) %>% 
  group_by(study_id) %>% 
  mutate(across(matches("eq5d5l_[q12345]*_numeric"), ~ .x - lag(.x), 
                .names = "{.col}_3m_12m_delta")) %>% 
  ungroup() %>% 
  mutate(
    eq5d5l_q_3m_12m_delta_change = select(., matches("eq5d5l_[q12345]*_numeric_3m_12m_delta")) %>% 
      apply(1, function(.x){
        case_when(
          any(.x > 0) & any(.x < 0) ~ "Ambiguous",
          any(.x > 0) ~ "Worse",
          any(.x < 0) ~ "Better",
          all(.x == 0) ~ "No change"
        )
      }
      )
  ) %>%  # write_csv("check_eq5d.csv")
  drop_na(eq5d5l_q_3m_12m_delta_change) %>% 
  count(eq5d5l_q_3m_12m_delta_change) %>% 
  mutate(nn = sum(n),
         prop = 100*n/nn)
```





