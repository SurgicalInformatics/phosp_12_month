---
title: "Longitudinal clustering"
author: "PHOSP-COVID collaborative"
output:
  word_document:
    reference_docx: template.docx 
---

```{r setup, include=FALSE}
library(finalfit)
library(knitr)
library(tidyverse)
library(rmarkdown)
library(lubridate)
library(recipes)
library(lcmm)
library(magrittr)

summary_factorlist <- purrr::partial(finalfit::summary_factorlist, na_to_prop = FALSE)

summary_factorlist_stratified <- function(.data, ..., split, colname_sep = "|", suffix_max_length = 10,
                                          n_common_cols = 2){
  
  df.out = .data %>% 
    group_by(!!! syms(split)) %>% 
    group_map(function(.x, .y){
      summary_factorlist(.x, ...) %>% 
        rename_with(paste0, colname_sep, 
                    .y %>% first() %>%
                      as.character() %>% 
                      map(stringr::str_trunc, suffix_max_length, ellipsis = "") %>% 
                      paste(collapse = colname_sep), 
                    .cols = -c(1:n_common_cols)) %>% 
        select(-c(1:n_common_cols)) 
    }
    ) %>% 
    bind_cols()
  
  summary_factorlist(.data, ...) %>% 
    select(1:n_common_cols) %>% 
    bind_cols(df.out)
}

mykable = function(x, row.names = FALSE){
  knitr::kable(x, row.names = row.names, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r", "r", "r")) 
}

knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
source("/home/eharrison/phosp_clean/02_functions.R")
```


```{r eval=FALSE, include=FALSE}
# Run once

# Find most recent date
# datadir = "/home/common/phosp/cleaned/full/"
# file_names = list.files(datadir, pattern="^phosp_hosp")
# timestamp = str_match(file_names, "phosp_hosp_([1234567890\\-_]*)")[,2] %>%
#   lubridate::ymd_hm() %>%
#   max() %>%
#   format("%Y-%m-%d_%H%M")

timestamp = "2021-09-08_1203"
# timestamp = "2021-09-03_1550"
# timestamp = "2021-07-27_0400"
# timestamp = "2021-08-16_0400"
# datadir = "/home/common/phosp/cleaned/full/"
# phosp   = read_rds(paste0(datadir, "phosp_", timestamp, "_full.rds")) # Use a version of phosp_clean.rds here.
datadir = "/home/common/phosp/raw/"
phosp   = read_rds(paste0(datadir, "phosp_", timestamp, ".rds")) # Use a version of phosp_clean.rds here. 
source("/home/eharrison/phosp_clean/03_prep.R") # After moving 3 month pre eq5d throughout
source("/home/eharrison/phosp_clean/05_kco.R") 
source("/home/eharrison/phosp_clean/06_truecolours_merge.R")
saveRDS(phosp, paste0("phosp_", timestamp, ".rds"))
saveRDS(phosp_wt, paste0("phosp_wt_", timestamp, ".rds"))
saveRDS(phosp_kco, paste0("phosp_kco_", timestamp, ".rds"))
saveRDS(phosp_tc, paste0("phosp_tc_", timestamp, ".rds"))
```

```{r}
# timestamp = "2021-07-27_0400"
# timestamp = "2021-08-16_0400"
# timestamp = "2021-09-03_1550"
timestamp = "2021-09-08_1203"
phosp = readRDS(paste0("phosp_", timestamp, ".rds"))
phosp_wt = readRDS(paste0("phosp_wt_", timestamp, ".rds"))
phosp_kco = readRDS(paste0("phosp_kco_", timestamp, ".rds"))
phosp_tc = readRDS(paste0("phosp_tc_", timestamp, ".rds"))
```

Latent process mixed models. A dynamic phenomenon (like recovery) can be characterized by a latent process which evolves over time. A latent process like recovery can be measured through several instruments, and the latent process (or construct) is their common factor. 
This clustering approach uses linear mixed models to identify subpopulations of patients, simply by the trajectory of their recovery over the multiple instruments. 


## Filtering

```{r}
phosp_working = phosp %>% 
  filter(is.na(redcap_repeat_instance)) %>%  # Remove repeat instruments, bloods, PFTs etc. 
  filter(redcap_event_name %in% c("3 Months (1st Research Visit)", "12 Months (2nd Research Visit)")) %>% 
  filter(tier == 2)
```

## True Colours
```{r}
# Match TC to 3 and 12 months
## The prep file for TC removes TC done on same day. 
## But there are still multiple TC questionnaires that match +/- 28 days

explanatory_hrqol = c(
  "gad7_summary",
  "phq9_summary",
  "pcl5_summary",
  "dyspnoea12_summary",
  "facit_item_total"
)

explanatory_tc = c(
  "gad7_summary_tc",
  "phq9_summary_tc",
  "pcl5_summary_tc",
  "d12_summary_tc",
  "facit_v4_summary_tc"
)

phosp_tc_match = phosp_working %>% 
  left_join(phosp_tc %>% 
              select(study_id, 
                     date_tc,
                     all_of(explanatory_tc)), by = "study_id") %>% 
  # Difference between clinic visit and TC
  mutate(date_tc_delta = (date_tc - crf3b_date_visit) %>% as.numeric()) %>% 
  # relocate(study_id, redcap_event_name, crf3b_date_visit, date_tc, date_tc_delta) %>% # tmp to manually inspect
  # Keep +/- 28 days
  filter(
    (date_tc_delta >= 0 & date_tc_delta <= 28) |
      (date_tc_delta < 0 & date_tc_delta >= -28)
  ) %>% 
  mutate(
    gad7_summary = if_else(is.na(gad7_summary), gad7_summary_tc, gad7_summary),
    phq9_summary = if_else(is.na(phq9_summary), phq9_summary_tc, phq9_summary),
    pcl5_summary = if_else(is.na(pcl5_summary), pcl5_summary_tc, pcl5_summary),
    dyspnoea12_summary = if_else(is.na(dyspnoea12_summary), d12_summary_tc, dyspnoea12_summary),
    facit_item_total = if_else(is.na(facit_item_total), facit_v4_summary_tc, facit_item_total)
  ) %>% 
  # Check at this point
  # select(study_id, redcap_event_name, crf3b_date_visit, date_tc, date_tc_delta,
  #        all_of(explanatory_tc), all_of(explanatory_hrqol))
  
  # More than one TC match for a given clinic, take earlier
  arrange(study_id, date_tc) %>% 
  group_by(study_id) %>% 
  slice(1) %>% 
  
  # This selection should match variable number with phosp_working
  select(-c(date_tc, date_tc_delta, explanatory_tc))
# 2421 variables in both phosp_tc_match and phosp_working

# Finish by replacing these patients in phosp_working
phosp_tc_match_study_id_event = phosp_tc_match %>% 
  mutate(drop = paste0(study_id, crf3b_date_visit)) %>% 
  pull(drop)

phosp_working_tc_match = phosp_working %>% 
  mutate(drop = paste0(study_id, crf3b_date_visit)) %>% 
  filter(!drop %in% phosp_tc_match_study_id_event) %>% 
  select(-drop) %>% 
  bind_rows(phosp_tc_match)
# Check this match row total for phosp_working
# 3361 x 2421

phosp_working = phosp_working_tc_match %>% 
  ff_relabel_df(phosp_working)
rm(phosp_working_tc_match, phosp_tc_match)
```

## Make variables
```{r}
phosp_working = phosp_working %>% 
  mutate(
    time2fu = (ymd(crf3b_date_visit) - ymd(crf1a_date_dis)) %>% as.numeric(units = "weeks"), # Change to - model convergence
    study_id2 = factor(study_id) %>% as.numeric(),
    patient_sq_l_t__new_disability = factor(patient_sq_l_t__new_disability)
  ) %>% 
  ff_relabel_df(phosp_working)
```

```{r}
phosp = phosp %>% 
  group_by(study_id) %>% 
  fill(crf3a_bmi, crf3a_bmi_2levels, crf3a_bmi_5levels, 
        patient_sq_n,
       .direction = "downup") %>% 
  ungroup()
```


## Error checking
```{r}
# Negative time to follow-ups
phosp_working = phosp_working %>% 
  filter(time2fu > 0)
```


## Variables to cluster on

```{r}
explanatory_hrqol = c(
  "gad7_summary",
  "phq9_summary",
  "pcl5_summary",
  "dyspnoea12_summary",
  "facit_item_total",
  "sppb_score",
  "mocal_total"
)
```

## Make a pairs upset plot

This is set up to show sets of complete data across 3 and 12 month instruments. 

```{r fig.height=4, fig.width=8}
# Patients with both 3 and 12 month data
paired_data = phosp_working %>% 
  select(study_id, redcap_event_name) %>% 
  count(study_id) %>% 
  filter(n == 2) %>% 
  pull(study_id)
cat("3m and 12m instruments available, n = ", length(paired_data))

library(naniar)
phosp_working %>% 
  filter(study_id %in% paired_data) %>% 
  select(study_id, redcap_event_name, explanatory_hrqol) %>% 
  group_by(study_id) %>% 
  summarise(
    across(explanatory_hrqol, ~ ifelse(!is.na(.) %>% any(), NA, "not paired"))
  ) %>% 
  select(-study_id) %>% 
  gg_miss_upset(nsets = 7)

```

## Multilevel imputation of compatible model
```{r}
library(mice)
## Choose to impute MoCA and SPPB, but require complete paired data for other instruments

## Choose other explanatory variables to impute from. 
explanatory_imputation = c("age_admission", 
                "crf1a_sex", 
                "crf1b_eth_5levels", 
                "imd_quintile",
                "crf3a_bmi",
                
                "crf1a_resp_support_4levels",
                
                # Comorbidities - # None of these are imputed
                "no_comorbid",
                # "crf1a_com_card", "crf1a_com_neupsy",
                # "crf1a_com_res", "crf1a_com_rheu",
                # "crf1a_com_gast", "crf1a_com_mer", 
                # "crf1a_com_mh", "crf1a_com_diab",
                # "crf1a_com_id",
                
                "crf1a_admission_duration",
                
                "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")
```

```{r eval=FALSE}
# Missingess in data going to imputation model
phosp_imputation_data = phosp_working %>% 
  filter(study_id %in% paired_data) %>%  # Only patients with 3m and 12m instruments - 1276 rows
  select(-explanatory_imputation) %>% 
  left_join(phosp %>% 
              filter(redcap_event_name == "Hospital Discharge") %>% 
              filter(is.na(redcap_repeat_instance)) %>% 
              select(study_id, explanatory_imputation)
  ) %>% 
  select(study_id, study_id2, redcap_event_name, time2fu, explanatory_imputation, explanatory_hrqol) %>% 
  # Must be complete on other instruments
  drop_na("gad7_summary",
          "phq9_summary",
          "pcl5_summary",
          "dyspnoea12_summary",
          "facit_item_total")

phosp_imputation_data %>% 
  missing_glimpse()

# This is needed to drop from imputed!
m0 = mice(phosp_imputation_data, maxit=0)
predM = m0$predictorMatrix
predM[,"study_id2"] = -2 # Specify ID
predM["study_id",] = 0
predM[,"redcap_event_name"] = 0
predM["redcap_event_name",] = 0
predM["study_id2","study_id2"] = 0
predM["sppb_score","time2fu"] = 2 # Allow time to be a random effect
predM["mocal_total","time2fu"] = 2


m0$method["sppb_score"] = "2l.pan"
m0$method["mocal_total"] = "2l.pan"

phosp_imputed = phosp_imputation_data %>% 
  mice(m = 10, maxit = 10, predictorMatrix = predM, method = m0$method, seed = 1)

plot(phosp_imputed)
summary(phosp_imputed)

phosp_working %>% select(mocal_total) %>% ff_glimpse
# min 1, max 30.
phosp_working %>% select(sppb_score) %>% ff_glimpse
 # min 0, max 12

phosp_imputed %>% mice::complete(1) %>% select(mocal_total) %>% ff_glimpse()
phosp_imputed %>% mice::complete(1) %>% select(sppb_score) %>% ff_glimpse()

saveRDS(phosp_imputed, file = paste0("phosp_imputed", timestamp, ".rds"))
```

```{r}
phosp_imputed = readRDS(paste0("phosp_imputed", timestamp, ".rds"))

# Manually truncate distributions. 
phosp_imputed_sets = phosp_imputed %>% 
  mice::complete("all") %>%
  purrr::map(~ mutate(., 
                      mocal_total = case_when(
                        mocal_total > 30 ~ 30,
                        mocal_total < 1 ~ 1,
                        TRUE ~ mocal_total),
                      sppb_score = case_when(
                        sppb_score > 12 ~ 12,
                        sppb_score < 0 ~ 0,
                        TRUE ~ sppb_score)
  )
  )
```

## Define paired data

At the moment, this requires all instruments to be complete at 3 and 12 months. 

```{r}
paired_study_id = phosp_working %>% 
  drop_na(explanatory_hrqol) %>% 
  count(study_id) %>% 
  filter(n == 2) %>% 
  pull(study_id)
cat("n = ", length(paired_study_id))

paired_study_id = phosp_imputed_sets[[1]] %>% 
  count(study_id) %>% 
  filter(n == 2) %>% 
  pull(study_id)
cat("Imputed pairs n = ", length(paired_study_id))
```



## Plot trajectories

Aim then is to cluster on these trajectories. Both in terms of magnitude on the scale and change over time. 

```{r fig.height=6, fig.width=8}
plot_data = phosp_working %>% 
  select(study_id, time2fu, explanatory_hrqol) %>% 
  labels_to_column() %>% 
  pivot_longer(-c(1, 2))

plot_data  %>% 
  ggplot_lancet(aes(x = time2fu, y = value, group = `REDCap ID`)) +
  geom_line(position=position_jitter(w=0.3, h=0.3), alpha = 0.12) + 
  facet_wrap(. ~ name, scales = "free_y") + 
  xlab("Weeks from hospital admission") + 
  ggtitle("Recovery trajectory by instrument (complete case)")
```

```{r fig.height=6, fig.width=8}
plot_data = phosp_imputed_sets[[1]] %>% 
  select(study_id, time2fu, explanatory_hrqol) %>% 
  labels_to_column() %>% 
  pivot_longer(-c(1, 2))

plot_data  %>% 
  ggplot_lancet(aes(x = time2fu, y = value, group = `REDCap ID`)) +
  geom_line(position=position_jitter(w=0.3, h=0.3), alpha = 0.12) + 
  facet_wrap(. ~ name, scales = "free_y") + 
  xlab("Weeks from hospital admission") + 
  ggtitle("Recovery trajectory by instrument (imputed)")
```

## Choose complete case or imputed

```{r}
# Complete case
model_data = phosp_working %>% 
  select(study_id, study_id2, redcap_event_name, time2fu, explanatory_hrqol) %>% 
  drop_na() %T>% 
  {data_in <<- .}

# Imputed
model_data = phosp_working %>% # Bring back unpaired patients
  select(study_id, study_id2, redcap_event_name, time2fu, explanatory_hrqol) %>% 
  filter(!study_id %in% phosp_imputed_sets[[1]]$study_id) %>% 
  bind_rows(phosp_imputed_sets[[1]] %>% 
              select(study_id, study_id2, redcap_event_name, time2fu, explanatory_hrqol)) %>% 
  drop_na() %T>% 
  {data_in <<- .}
```

## Normalise and reverse moca / sppb scale

```{r}
model_data = model_data %>% 
  recipe(~ .) %>% 
  step_normalize(explanatory_hrqol) %>% 
  prep() %>% 
  juice() %>% 
  mutate(across(c(mocal_total, sppb_score), ~ . * -1)) %>%     # Reverse scale for these
  as.data.frame()
```


```{r fig.height=6, fig.width=12}
model_data %>% 
  pivot_longer(explanatory_hrqol) %>% 
  ggplot_lancet(aes(value)) + 
  geom_histogram() + 
  facet_grid(redcap_event_name ~ name, scale = "free_x") + 
  ggtitle("Distribution of patients by instrument (all)")
```

```{r fig.height=6, fig.width=12}
model_data %>% 
  filter(study_id %in% paired_study_id) %>% 
  pivot_longer(explanatory_hrqol) %>% 
  ggplot_lancet(aes(value)) + 
  geom_histogram() + 
  facet_grid(redcap_event_name ~ name, scale = "free_x") + 
  ggtitle("Distribution of patients by instrument (paired")
```

Distributions are tricky. Gaussian and spline models run unsuccessfully (at bottom). 
Use beta models given bounded non-normal distribution of instruments. 

Important, these use all available data to cluster trajectory, including unpaired patients. 

## Beta models

```{r eval=FALSE}
library(lcmm)
set.seed(1234)
m1_beta = map(1, ~ multlcmm(fixed = gad7_summary + phq9_summary + 
                          pcl5_summary + dyspnoea12_summary + 
                           facit_item_total + sppb_score + mocal_total ~ 
                           
                           time2fu, 
                         random = ~ time2fu, subject = "study_id2", 
                         
                         ng = .,
                         link = 'beta',
                         randomY = TRUE,
                         data = model_data,
                         
                         maxiter = 100)
)
saveRDS(m1_beta, file = paste0("m1_beta_imputed_", timestamp, ".rds"))

k = 2:6 %>% as.list()
m2_beta = map(k, ~ multlcmm(fixed = gad7_summary + phq9_summary + 
                           pcl5_summary + dyspnoea12_summary + 
                           facit_item_total + sppb_score + mocal_total ~ 
                           
                           time2fu, 
                         mixture = ~ time2fu,
                         random = ~ time2fu, subject = "study_id2", 
                         
                         ng = .,
                         link = 'beta',
                         randomY = TRUE, 
                         
                         B = m1_beta[[1]], # Use ng = 1 model for initial values
                         data = model_data,
                         maxiter = 100)
)
saveRDS(m2_beta, file = paste0("m2_beta_imputed_", timestamp, ".rds"))
m_beta = c(m1_beta, m2_beta)
```

```{r include=FALSE}
# m1_beta = readRDS("m1_beta2.rds")
# m2_beta = readRDS("m2_beta2.rds")
# m_beta = c(m1_beta, m2_beta)

m1_beta = readRDS(paste0("m1_beta_imputed_", timestamp, ".rds"))
m2_beta = readRDS(paste0("m2_beta_imputed_", timestamp, ".rds"))
m_beta = c(m1_beta, m2_beta)
```

```{r}
t1 = summarytable(m_beta[[1]], m_beta[[2]], m_beta[[3]],
             m_beta[[4]], m_beta[[5]], m_beta[[6]],
             which =c( "G", "loglik", "conv", "npm",
                       "AIC", "BIC", "SABIC", 
                       "entropy", "ICL", "%class"),
             display = FALSE) 

t1 %>% 
  as_data_frame() %>% 
  rename("Number of clusters" = "G")
```

Choose model 5 that has 4 effective clusters. 

```{r eval=FALSE, include=FALSE}
m5 = m_beta[[5]]
summary(m5)
```

```{r eval=FALSE, include=TRUE}
# Model checks
## Not printed. 
plot(m5)
plot(m5, which="linkfunction")
plot(m5, which="postprob")
plot(m5, which="link")
plot(m5, which="fit", var.time = "time2fu")
```

## Run imputed sets for chosen number of clusters 

```{r eval=FALSE}
# Use all imputed sets
model_data_imputed = phosp_imputed_sets %>% 
  map(~ .x %>% 
        select(study_id, study_id2, redcap_event_name, time2fu, explanatory_hrqol) %>% 
       bind_rows(
         phosp_working %>% # Bring back unpaired patients
           select(study_id, study_id2, redcap_event_name, time2fu, explanatory_hrqol) %>% 
           filter(!study_id %in% phosp_imputed_sets[[1]]$study_id)
       ) %>% 
        drop_na() %>%
        recipe(~ .) %>% 
        step_normalize(explanatory_hrqol) %>% 
        prep() %>% 
        juice() %>% 
        mutate(across(c(mocal_total, sppb_score), ~ . * -1)) %>%     # Reverse scale for these
        as.data.frame()
  )
# Check they match. 
model_data_imputed[[1]] %>% arrange(study_id2, redcap_event_name) %>% head
model_data %>% arrange(study_id2, redcap_event_name) %>% head

set.seed(1234)
# 10 sets of model 5 (4 effective clusters)
m5_beta_all_imputed = model_data_imputed %>% 
  map(~ multlcmm(fixed = gad7_summary + phq9_summary + 
                   pcl5_summary + dyspnoea12_summary + 
                   facit_item_total + sppb_score + mocal_total ~ 
                   
                   time2fu, 
                 mixture = ~ time2fu,
                 random = ~ time2fu, subject = "study_id2", 
                 
                 ng = 5,
                 link = 'beta',
                 randomY = TRUE, 
                 
                 B = m1_beta[[1]], # Use ng = 1 model for initial values
                 data = .x,
                 maxiter = 100)
  )
saveRDS(m5_beta_all_imputed, file = paste0("m5_beta_all_imputed", timestamp, ".rds"))
```

```{r}
m5_beta_all_imputed = readRDS(paste0("m5_beta_all_imputed", timestamp, ".rds"))
```

```{r}
# Mean of class probabilities across 10 imputed models
m5_beta_all_imputed_class = m5_beta_all_imputed %>% 
  # Extract matrices of class probabiliites
  map(~ .x$pprob %>% 
        select(-c(1, 2)) %>% 
        as.matrix()
  ) %>% 
  # Take mean prob across imputed sets
  Reduce('+', .) %>% 
  {. / 10} %>% 
  as.data.frame() %>% 
  # Bring study_id2 back in. 
  bind_cols(study_id2 = m5_beta_all_imputed[[1]]$pprob[, c(1)], 
            .) %>% 
  tibble() %>% 
  # Pivot and retain highest probability
  pivot_longer(matches("prob.+")) %>% 
  group_by(study_id2) %>% 
  slice_max(value) %>% 
  mutate(class = str_extract(name, "[:digit:]")) %>% # Check here. 
  ungroup()

```

## Join clusters with other data

```{r}
explanatory = c("swab_pcr_result", 
                "age_admission", 
                "crf1a_sex", 
                "crf1b_eth_5levels", 
                "imd_quintile",
                "crf3a_bmi",
                "crf3a_bmi_2levels",
                "crf3a_bmi_5levels", 
                
                "patient_sq_n",
                
                # Comorbidities
                "no_comorbid",
                "crf1a_com_card", "crf1a_com_neupsy",
                "crf1a_com_res", "crf1a_com_rheu",
                "crf1a_com_gast", "crf1a_com_mer", 
                "crf1a_com_mh", "crf1a_com_diab",
                "crf1a_com_id",
                
                "crf1a_admission_duration",
                
                "crf1a_resp_support_4levels",
                
                "crf1a_treat_ss", "crf1a_treat_at", "crf1a_treat_tdac")
```

```{r eval=FALSE, include=FALSE}
# Single non-imputed example

# Bring in baseline 
phosp_m5 = m5$pprob %>% 
  tibble() %>% 
  select(study_id2, class) %>% 
  mutate(study_id2 = as.character(study_id2) %>% as.numeric()) %>% 
  left_join(phosp %>%                          # This doesn't yet use other imputed variables, age, bmi etc.
              filter(redcap_event_name == "Hospital Discharge") %>% 
              filter(is.na(redcap_repeat_instance)) %>% 
              select(study_id, explanatory) %>% 
              right_join(data_in)
  ) %>% 
  mutate(class = factor(class))

# Bring in 3 and 12 month variables

explanatory_differences = c("psq_recovered",
                            "eq5d5l_summary_pre",
                            "eq5d5l_summary",
                            "eq5d5l_summary_delta_change",
                            
                            # Pull delta_change names
                            phosp %>% 
                              select(matches("eq5d5l_q.*_delta_change")
                              ) %>% 
                              names(),
                            "eq5d5l_utility_index_pre",
                            "eq5d5l_utility_index",
                            "eq5d5l_utility_index_delta",
                            
                            "patient_sq_l_t_disability",
                            "patient_sq_l_t__new_disability")

explanatory_hrqol_full = c("gad7_summary_2levels",
                      "gad7_summary",
                      "phq9_summary_2levels",
                      "phq9_summary",
                      "pcl5_summary_2levels",
                      "pcl5_summary",
                      "dyspnoea12_summary",
                      "facit_item_total",
                      "bpi_severity_summary",
                      "bpi_interference_summary",
                      "sppb_score",
                      "sppb_score_summary",
                      "rcf_score_summary",
                      "rcf_score",
                      "mocal_total_summary",
                      "mocal_total",
                      "mocal_total_corrected",  
                      "mocal_total_corrected_summary")

phosp_m5 = phosp_m5 %>% 
  left_join(
    phosp_working %>% 
      select(study_id, redcap_event_name, explanatory_differences, explanatory_hrqol_full)
  )
```

```{r}
# Imputed example
# Bring in baseline 
phosp_m5 = phosp_imputed_sets[[1]] %>% 
  # distinct(study_id, .keep_all = TRUE) %>%
  # filter(study_id %in% paired_study_id) %>% 
  left_join(m5_beta_all_imputed_class %>% 
              select(study_id2, class) %>% 
              mutate(study_id2 = as.character(study_id2) %>% as.numeric())
  ) %>% 
  left_join(phosp %>% 
              filter(redcap_event_name == "Hospital Discharge") %>% 
              filter(is.na(redcap_repeat_instance)) %>% 
              select(study_id, explanatory) %>% 
              select(-explanatory_imputation)
  ) %>% 
  mutate(class = factor(class))

# Bring in 3 and 12 month variables
explanatory_differences = c("psq_recovered",
                            "eq5d5l_summary_pre",
                            "eq5d5l_summary",
                            "eq5d5l_summary_delta_change",
                            
                            # Pull delta_change names
                            phosp %>% 
                              select(matches("eq5d5l_q.*_delta_change")
                              ) %>% 
                              names(),
                            "eq5d5l_utility_index_pre",
                            "eq5d5l_utility_index",
                            "eq5d5l_utility_index_delta",
                            
                            "patient_sq_l_t_disability",
                            "patient_sq_l_t__new_disability")

explanatory_hrqol_full = c("gad7_summary_2levels",
                      "gad7_summary",
                      "phq9_summary_2levels",
                      "phq9_summary",
                      "pcl5_summary_2levels",
                      "pcl5_summary",
                      "dyspnoea12_summary",
                      "facit_item_total",
                      "bpi_severity_summary",
                      "bpi_interference_summary",
                      "sppb_score",
                      "sppb_score_summary",
                      "rcf_score_summary",
                      "rcf_score",
                      "mocal_total_summary",
                      "mocal_total",
                      "mocal_total_corrected",  
                      "mocal_total_corrected_summary")

phosp_m5 = phosp_m5 %>% 
  left_join(
    phosp_working %>% 
      select(study_id, redcap_event_name, explanatory_differences, explanatory_hrqol_full) %>% 
      select(-explanatory_hrqol)
  )

phosp_m5 %>% count(class)

# Fix cluster numbers. 
phosp_m5 = phosp_m5 %>% 
  mutate(
    class = fct_recode(class,
                       "3" = "4",
                       "4" = "5")
  )
```

## Plot clusters
```{r fig.height=6, fig.width=8}
phosp_m5 %>% 
  filter(study_id %in% paired_study_id) %>% 
  select(study_id, class, time2fu, explanatory_hrqol) %>%
  labels_to_column() %>% 
  pivot_longer(-c(1:3)) %>% 
  ggplot_lancet(aes(x = time2fu, y = value, colour = class)) + 
  geom_line(aes(group = `REDCap ID`), alpha = 0.1) + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(. ~ name, scale = "free_y") +
  geom_smooth(se = FALSE, method = "gam") + 
  #geom_smooth(se = FALSE, method = "gam", formula = y ~ s(x, bs = "cr")) + 
  #geom_smooth(se = FALSE) + 
  labs(x = "Follow-up time (weeks after discharge)", colour = "Cluster") + 
  ggtitle("Patient trajectories classified by cluster")
```

My interpretation. 

* Red (1) have greatest deficit and don't get better. 
* Blue (2) have moderate defict but get better.
* Green (3) have minimal deficit and improve from this. 
* Purple (4) have initial minimal deficit but get worse. 

```{r eval=FALSE, include=FALSE}
time_sim = seq(20, 60, 2)
newdata = data.frame(time2fu = time_sim)
p_m5_beta = predictY(m5, newdata=newdata, var.time = "time2fu")

p_m5_beta$pred %>% 
  mutate(time2fu = rep(time_sim, length(explanatory_hrqol))) %>% 
  select(-Ypred_class5) %>% # This is identical to class 3 and no patients in it. 
  pivot_longer(matches("Ypred.*")) %>% 
  ggplot(aes(x = time2fu, y = value, colour = name)) + 
  geom_line() + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(. ~ Yname, scale = "free_y") 
```

```{r eval=FALSE, include=FALSE}
time_sim = seq(20, 60, 2)
newdata = data.frame(time2fu = time_sim)
m5 = m5_beta_all_imputed[[1]]
p_m5_beta = predictY(m5, newdata=newdata, var.time = "time2fu")

p_m5_beta$pred %>% 
  mutate(time2fu = rep(time_sim, length(explanatory_hrqol))) %>% 
  select(-Ypred_class5) %>% # This is identical to class 3 and no patients in it. 
  pivot_longer(matches("Ypred.*")) %>% 
  ggplot(aes(x = time2fu, y = value, colour = name)) + 
  geom_line() + 
  scale_colour_brewer(palette = "Set1") +
  facet_wrap(. ~ Yname, scale = "free_y") 
```

## Paired patients by clusters

### Row proportions
```{r}
dependent = "class"

phosp_m5 %>% 
  distinct(study_id, .keep_all = TRUE) %>% 
  filter(study_id %in% paired_study_id) %>% 
  summary_factorlist(dependent,  explanatory, 
                     na_include = TRUE, p = TRUE,
                     add_col_totals = TRUE, column = FALSE,
                     total_col = TRUE) %>% 
  mytable()
```


### Column proportions
```{r}
dependent = "class"

phosp_m5 %>% 
  distinct(study_id, .keep_all = TRUE) %>% 
  filter(study_id %in% paired_study_id) %>% 
  summary_factorlist(dependent,  explanatory, 
                     na_include = TRUE, p = TRUE,
                     add_col_totals = TRUE, column = TRUE,
                     total_col = TRUE) %>% 
  mytable()
```

```{r fig.height=6, fig.width=8}
phosp_m5 %>% 
  filter(study_id %in% paired_study_id) %>% 
  group_by(redcap_event_name, class) %>% 
  count(psq_recovered) %>% 
  drop_na(psq_recovered) %>% 
  mutate(nn = sum(n),
         prop = 100*n/nn) %>% 
  filter(psq_recovered == "Yes") %>% 
  ggplot_lancet(aes(redcap_event_name, prop, fill = class)) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = "Set1") + 
  labs(x = "Research visit", y = "Proportion yes (%)", fill = "Cluster") +
  ggtitle("Do you feel fully recovered from COVID-19?") + 
  theme(legend.position = c(0.05, 1),
        legend.justification = c(0, 1))
```


## Table 2: Clusters by HRQoL

```{r}
phosp_m5 %>% 
  filter(study_id %in% paired_study_id) %>% 
  mutate(
    redcap_event_name = fct_recode(redcap_event_name,
                              "3m" = "3 Months (1st Research Visit)",
                              "12m" = "12 Months (2nd Research Visit)")
    )%>% 
      summary_factorlist_stratified(dependent = dependent, explanatory = explanatory_differences,
                                    na_include = TRUE, total_col= TRUE, add_col_totals = TRUE,
                                    digits = c(2, 2, 3, 1), p = TRUE, 
                              split = "redcap_event_name")   %>% 
  mytable()
```

## Table 3

```{r}
phosp_wt_table = phosp_wt %>% 
  filter(wt_type == "Incremental shuttle walk test (ISWT) Modified 15 level") %>% 
  drop_na(wt_distance) %>% 
  mutate(wt_iswt_predicted_perc = replace_na(wt_iswt_predicted_perc, 0)) %>% # to deal with max returning inf
  group_by(study_id, redcap_event_name) %>%  # More than one test per patient
  mutate(value_max = if_else(row_number() == which.max(wt_iswt_predicted_perc), TRUE, FALSE)) %>% 
  filter(value_max) %>% 
  select(study_id, wt_distance, wt_iswt_predicted_perc) %>% 
  as.data.frame() %>% 
  ff_relabel_df(phosp_wt)

phosp_pft_table = phosp %>% 
  filter(redcap_repeat_instrument == "Pulmonary Functional Tests") %>% 
  filter(pft_spm_done == "Yes") %>% 
  select(study_id, redcap_event_name, starts_with("pft_")) %>% 
  drop_na(pft_fev1) %>% 
  group_by(study_id, redcap_event_name) %>% 
  mutate(value_max = if_else(row_number() == which.max(pft_fev1), TRUE, FALSE)) %>% 
  filter(value_max) %>% 
  select("pft_fev1_perc_pred",
         "pft_fev1",
         "pft_fev1_perc_pred_80",
         "pft_fvc_perc_pred",
         "pft_fvc",
         "pft_fvc_perc_pred_80",
         "pft_fev1_fvc_70") %>% 
  as.data.frame() %>% 
  ff_relabel_df(phosp)

# Do kco and tlco extraction and percentage normal separately. 
phosp_kco_table = phosp %>% 
  filter(redcap_repeat_instrument == "Pulmonary Functional Tests") %>% 
  filter(pft_spm_done == "Yes") %>% 
  select(study_id, redcap_event_name, pft_tlco, pft_kco) %>% 
  drop_na(pft_kco) %>% 
  left_join(phosp_kco %>% select(study_id, tlcoM_SI_pred, kcoM_SI_pred)) %>% 
  mutate(
    pft_tlco_pred = (100 * pft_tlco / tlcoM_SI_pred) %>% ff_label("TLCO % predicted"),
    pft_kco_pred = (100 * pft_kco / kcoM_SI_pred) %>% ff_label("KCO % predicted"),
    
    pft_tlco_pred_80 = case_when(
      pft_tlco_pred < 80 ~ "Yes",
      pft_tlco_pred >= 80 ~ "No",
    ) %>% 
      ff_label("TLCO predicted <80%"),
    
    pft_kco_pred_80 = case_when(
      pft_kco_pred < 80 ~ "Yes",
      pft_kco_pred >= 80 ~ "No",
    ) %>% 
      ff_label("KCO predicted <80%"),
    
  ) %>% 
  ff_relabel_df(phosp)

phosp_pft_table = phosp_pft_table %>% 
  left_join(phosp_kco_table)
```


```{r}
phosp_bloods_table = phosp %>% 
  filter(redcap_repeat_instrument == "Laboratory Results Collection Log - Routine blood tests") %>% 
  group_by(study_id, redcap_event_name) %>% 
  summarise(
    # This needs to summarise over multiple blood tests per visit. 
    # Take max values and yes over no. 
    # Convoluted by necessity. 
    # note case_when doesn't currently work with any. Known issue Feb 21
    bnp_result = ifelse(all(is.na(bnp_result)), NA, max(bnp_result, na.rm = TRUE)),
    pnbnp_result = ifelse(all(is.na(pnbnp_result)), NA, max(pnbnp_result, na.rm = TRUE)),
    bnp_summary = ifelse(any(bnp_summary == "Yes", na.rm = TRUE), "Yes", 
                         ifelse(any(bnp_summary == "No", na.rm = TRUE), "No", 
                                NA)),
    
    hba1c_result = ifelse(all(is.na(hba1c_result)), NA, max(hba1c_result, na.rm = TRUE)),
    hba1c_summary = ifelse(any(hba1c_summary == "Yes", na.rm = TRUE), "Yes", 
                           ifelse(any(hba1c_summary == "No", na.rm = TRUE), "No", 
                                  NA)),
    
    egfr_result = ifelse(all(is.na(egfr_result)), NA, max(egfr_result, na.rm = TRUE)),
    egfr_summary = ifelse(any(egfr_summary == "Yes", na.rm = TRUE), "Yes", 
                          ifelse(any(egfr_summary == "No", na.rm = TRUE), "No", 
                                 NA)),
    
    ddi_result = ifelse(all(is.na(ddi_result)), NA, max(ddi_result, na.rm = TRUE)),
    ddi_summary = ifelse(any(ddi_summary == "Yes", na.rm = TRUE), "Yes", 
                         ifelse(any(ddi_summary == "No", na.rm = TRUE), "No", 
                                NA)),
    
    crp_result = ifelse(all(is.na(crp_result )), NA, max(crp_result , na.rm = TRUE)),
    crp_summary = ifelse(any(crp_summary  == "Yes", na.rm = TRUE), "Yes", 
                         ifelse(any(crp_summary == "No", na.rm = TRUE), "No", 
                                NA)),
    
    crp_summary5 = ifelse(any(crp_summary5  == "Yes", na.rm = TRUE), "Yes", 
                         ifelse(any(crp_summary5 == "No", na.rm = TRUE), "No", 
                                NA))
  ) %>%
  ungroup() %>% 
  ff_relabel_df(phosp)

explanatory_hrqol_full = c("gad7_summary_2levels",
                      "gad7_summary",
                      "phq9_summary_2levels",
                      "phq9_summary",
                      "pcl5_summary_2levels",
                      "pcl5_summary",
                      "dyspnoea12_summary",
                      "facit_item_total",
                      "bpi_severity_summary",
                      "bpi_interference_summary",
                      "sppb_score",
                      "sppb_score_summary",
                      "rcf_score_summary",
                      "rcf_score",
                      "mocal_total_summary",
                      "mocal_total",
                      "mocal_total_corrected",  
                      "mocal_total_corrected_summary")


explanatory_labs = c("wt_distance",
                     "wt_iswt_predicted_perc",
                     "pft_fev1_perc_pred", 
                     "pft_fev1_perc_pred_80",
                     "pft_fvc_perc_pred_80",
                     "pft_fev1_fvc_70",
                     "pft_tlco",
                     "pft_tlco_pred",
                     "pft_tlco_pred_80",
                     "pft_kco",           
                     "pft_kco_pred",
                     "pft_kco_pred_80",
                     "bnp_summary",
                     "hba1c_summary",
                     "egfr_summary",
                     "ddi_result",
                     "ddi_summary",
                     "crp_summary5",
                     "crp_summary"
)
```


```{r}
phosp_m5 %>%
  filter(study_id %in% paired_study_id) %>% 
  left_join(phosp_wt_table) %>% 
  left_join(phosp_pft_table) %>% 
  left_join(phosp_bloods_table) %>% 
  select(study_id, redcap_event_name, dependent, explanatory_hrqol_full, explanatory_labs) %>% 
  mutate(across(is.character, factor)) %>% 
  mutate(
    redcap_event_name = fct_recode(redcap_event_name,
                                   "3m" = "3 Months (1st Research Visit)",
                                   "12m" = "12 Months (2nd Research Visit)")
  ) %>%
  ff_relabel_df(phosp) %>% 
  
  summary_factorlist_stratified(dependent = dependent, explanatory = c(explanatory_hrqol, explanatory_labs),
                                na_include = TRUE, total_col= TRUE, add_col_totals = TRUE,
                                add_row_totals = TRUE, include_row_missing_col = FALSE,
                                digits = c(2, 2, 3, 1), p = TRUE, 
                                split = "redcap_event_name", 
                                n_common_cols = 3) %>% 
  mytable()
```

























## Log transform

These don't look good, below, so I went back to beta to work out why not converging. Not enough samples / linked patients?

```{r eval=FALSE, include=FALSE}
library(recipes)
model_data2 = phosp_working %>% 
  select(study_id, study_id2, time2fu, explanatory_hrqol) %>% 
  
  filter(mocal_total > 10) %>% # Note this, moca = 1, ~ 15 SD away from mean. 
  
  drop_na() %T>% 
  {data_in <<- .} %>% 
  recipe(~ .) %>% 
  step_log(explanatory_hrqol, offset = 0.01) %>% 
  step_normalize(explanatory_hrqol) %>% 
  prep() %>% 
  juice() %>% 
  mutate(across(c(mocal_total, sppb_score), ~ . * -1)) %>%     # Reverse scale for these
  as.data.frame()

model_data2 %>% 
  pivot_longer(explanatory_hrqol) %>% 
  ggplot(aes(value)) + 
  geom_histogram() + 
  facet_wrap(~ name, scale = "free_x")
```


These gave odd results, possibly because of outliers or because distributions far from gaussian. 

```{r eval=FALSE, include=FALSE}
# On initial exploration, nothing above 5 worth looking at. 

library(lcmm)
fit1_lin = map(1, ~ multlcmm(fixed = gad7_summary + phq9_summary + 
                          pcl5_summary + dyspnoea12_summary + 
                           facit_item_total + sppb_score + mocal_total ~ 
                           
                           time2fu, 
                         random = ~ time2fu, subject = "study_id2", 
                         
                         ng = .,
                         randomY = FALSE, # What is this and should it be true?
                         data = model_data2)
)
saveRDS(fit1_lin, file = "multlcmm_lin1.rds")

k = 2:5 %>% as.list()
fit2_lin = map(k, ~ multlcmm(fixed = gad7_summary + phq9_summary + 
                           pcl5_summary + dyspnoea12_summary + 
                           facit_item_total + sppb_score + mocal_total ~ 
                           
                           time2fu, 
                         mixture = ~ time2fu,
                         random = ~ time2fu, subject = "study_id2", 
                         
                         ng = .,
                         randomY = FALSE, # What is this and should it be true?
                         
                         B = fit1_lin[[1]], # Use ng = 1 model for initial values
                         data = model_data)
)
saveRDS(fit2_lin, file = "multlcmm_lin2.rds")

fit = c(fit1_lin, fit2_lin)
```

```{r eval=FALSE, include=FALSE}
summarytable(fit[[1]], fit[[2]], fit[[3]], 
             fit[[4]], fit[[5]],
             which =c( "G", "loglik", "conv", "npm",
                       "AIC", "BIC", "SABIC", 
                       "entropy", "ICL", "%class"))
```

```{r eval=FALSE, include=FALSE}
m4 = fit[[4]]
m4
str(m4)

tmp = m4$pprob %>% 
  tibble() %>% 
  select(study_id, class) %>% 
  mutate(study_id = as.character(study_id) %>% as.numeric())%>% 
  left_join(phosp_working)

model_data2_new = data.
data_pred0 <- data.frame(age=seq(65,95,length.out=50),CEP=0)
data_pred1 <- data.frame(age=seq(65,95,length.out=50),CEP=1)
data_pred0$age65 <- (data_pred0$age - 65)/10
data_pred1$age65 <- (data_pred1$age - 65)/10
 
model2

 
m4$pprob$class
pred0 <- predictY(m2d, data_pred0, var.time = "age")
pred1 <- predictY(m2d, data_pred1, var.time = "age")
```


## Spline models

```{r eval=FALSE, include=FALSE}

# These are not good models. 

library(lcmm)
set.seed(1234)
m1_spline = map(1, ~ multlcmm(fixed = gad7_summary + phq9_summary + 
                          pcl5_summary + dyspnoea12_summary + 
                           facit_item_total + sppb_score + mocal_total ~ 
                           
                           time2fu, 
                         random = ~ time2fu, subject = "study_id2", 
                         
                         ng = .,
                         link = '3-quant-splines',
                         randomY = TRUE, # What is this and should it be true?
                         data = model_data,
                         
                         maxiter = 100)
)

saveRDS(m1_spline, file = "m1_spline.rds")


k = 2:6 %>% as.list()
m2_spline = map(k, ~ multlcmm(fixed = gad7_summary + phq9_summary + 
                           pcl5_summary + dyspnoea12_summary + 
                           facit_item_total + sppb_score + mocal_total ~ 
                           
                           time2fu, 
                         mixture = ~ time2fu,
                         random = ~ time2fu, subject = "study_id2", 
                         
                         ng = .,
                         link = '3-quant-splines',
                         randomY = TRUE, 
                         
                         B = m1_spline[[1]], # Use ng = 1 model for initial values
                         data = model_data,
                         maxiter = 100)
)
saveRDS(m2_spline, file = "m2_spline.rds")

m_spline = c(m1_spline, m2_spline)
```

```{r eval=FALSE, include=FALSE}
summarytable(m_spline[[1]], m_spline[[2]], m_spline[[3]],
             m_spline[[4]], m_spline[[5]], m_spline[[6]],
             which =c( "G", "loglik", "conv", "npm",
                       "AIC", "BIC", "SABIC", 
                       "entropy", "ICL", "%class"))
```
